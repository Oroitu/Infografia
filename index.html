<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantilla dinámica de infografías</title>
  <style>
    :root{
      color-scheme: light dark;
      --color-background:#0e3a5a;
      --color-background-elevated:rgba(14,58,90,0.9);
      --color-on-background:#ffffff;
      --color-surface:#0f2840;
      --color-on-surface:#e9f4ff;
      --color-surface-border:rgba(255,255,255,0.12);
      --color-paper:#ffffff;
      --color-paper-muted:#f6fbff;
      --color-paper-border:rgba(14,34,51,0.12);
      --color-text-primary:#0b1f2c;
      --color-text-secondary:#6b7b88;
      --color-accent:#2e69a1;
      --color-on-accent:#ffffff;
      --color-accent-strong:#0c3250;
      --color-on-accent-strong:#ffffff;
      --font-heading:'Poppins','Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      --font-body:ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans','Liberation Sans','Apple Color Emoji','Segoe UI Emoji';
      --font-weight-heading:700;
      --font-weight-body:400;
      --spacing-xs:4px;
      --spacing-sm:8px;
      --spacing-md:12px;
      --spacing-lg:18px;
      --spacing-xl:26px;
      --spacing-2xl:36px;
      --spacing-density:standard;
      --radius-none:0px;
      --radius-sm:8px;
      --radius-md:14px;
      --radius-lg:18px;
      --shadow-sm:0 1px 2px rgba(0,0,0,0.12);
      --shadow-md:0 12px 34px rgba(0,0,0,0.18);
      --shadow-lg:0 18px 50px rgba(0,0,0,0.24);
      --control-background:rgba(255,255,255,0.06);
      --control-border:rgba(255,255,255,0.15);
      --control-text:var(--color-on-surface);
      --size-row-unit:2px;
      --grid-column-gap:var(--spacing-lg);
      --fab-size:54px;
      --toolbar-size:38px;
      --canvas-padding: min(4vw, var(--spacing-2xl));
    }

    *, *::before, *::after{box-sizing:border-box}

    body{
      margin:0;
      font-family:var(--font-body);
      font-weight:var(--font-weight-body);
      min-height:100vh;
      background:radial-gradient(circle at 20% 20%, rgba(255,255,255,0.16) 0 12%, transparent 35%), linear-gradient(160deg,var(--color-background) 0 40%, var(--color-accent) 40% 41%, var(--color-surface) 41%);
      color:var(--color-text-primary);
      display:flex;
      flex-direction:column;
    }

    .workspace{
      position:relative;
      flex:1;
      display:flex;
      padding:var(--canvas-padding);
      justify-content:center;
      align-items:flex-start;
    }

    .infographic{
      width: min(1240px, 100%);
      min-height: min(90vh, 1300px);
      background:var(--color-paper);
      color:var(--color-text-primary);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-lg);
      position:relative;
      padding:clamp(24px, 5vw, 64px);
      display:flex;
      flex-direction:column;
      gap:var(--spacing-lg);
      transition:box-shadow 160ms ease, transform 160ms ease;
    }

    .infographic:focus-within{
      box-shadow:0 0 0 4px color-mix(in srgb, var(--color-accent) 28%, transparent), var(--shadow-lg);
    }

    .ig-header{
      border-bottom:var(--header-accent-thickness, 5px) solid var(--color-accent);
      padding-bottom:var(--spacing-md);
    }

    [data-editable]{
      outline:none;
      border-radius:var(--radius-sm);
      transition:background 120ms ease, box-shadow 120ms ease;
    }

    [data-editable]:focus-visible{
      background:color-mix(in srgb, var(--color-accent) 12%, transparent);
      box-shadow:0 0 0 2px var(--color-accent);
    }

    .ig-header h1{
      margin:0;
      font-size:clamp(36px, 4vw, 64px);
      font-family:var(--font-heading);
      font-weight:var(--font-weight-heading);
      color:var(--color-accent);
    }

    .ig-header h2{
      margin:var(--spacing-xs) 0 0;
      color:var(--color-text-secondary);
      font-size:clamp(18px, 2vw, 28px);
    }

    .ig-grid{
      flex:1;
      display:grid;
      grid-template-columns:repeat(var(--cols, 3), minmax(0, 1fr));
      gap:var(--grid-column-gap);
    }

    .block-wrapper{
      position:relative;
    }

    .block-wrapper.drop-before::before,
    .block-wrapper.drop-after::after{
      content:'';
      position:absolute;
      left:calc(var(--spacing-sm) * -1);
      right:calc(var(--spacing-sm) * -1);
      height:4px;
      background:var(--color-accent);
      border-radius:999px;
      box-shadow:0 0 0 2px color-mix(in srgb, var(--color-accent) 28%, transparent);
      pointer-events:none;
      z-index:1;
    }

    .block-wrapper.drop-before::before{
      top:calc(var(--spacing-sm) * -1);
    }

    .block-wrapper.drop-after::after{
      bottom:calc(var(--spacing-sm) * -1);
    }

    .block{
      position:relative;
      border-radius:var(--block-radius, var(--radius-md));
      border:var(--block-border-width, 1px) var(--block-border-style, solid) var(--block-border-color, var(--color-paper-border));
      background:var(--block-background, var(--color-paper-muted));
      box-shadow:var(--block-shadow, none);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .block.fill-ink{
      background:var(--block-ink-background, var(--color-accent-strong));
      color:var(--block-ink-text, var(--color-on-accent-strong));
    }

    .block .pad{
      padding:var(--block-padding, var(--spacing-md));
      display:flex;
      flex-direction:column;
      gap:var(--spacing-sm);
      flex:1;
    }

    .block h3{
      margin:0;
      font-family:var(--font-heading);
      font-size:clamp(18px, 1.8vw, 26px);
      font-weight:var(--font-weight-heading);
    }

    .block p{
      margin:0;
      line-height:1.55;
      font-size:16px;
    }

    .block[data-kind="list"] .list{
      margin:0;
      padding-left:var(--list-indent, var(--spacing-md));
      display:flex;
      flex-direction:column;
      gap:var(--list-gap, var(--spacing-md));
    }

    .block[data-kind="list"] .list li{
      margin:0;
      line-height:1.55;
    }

    .block-toolbar{
      position:absolute;
      top:var(--spacing-xs);
      left:var(--spacing-xs);
      display:flex;
      background:color-mix(in srgb, var(--color-surface) 92%, transparent);
      border-radius:var(--radius-sm);
      border:1px solid color-mix(in srgb, var(--color-on-surface) 12%, transparent);
      box-shadow:var(--shadow-sm);
      overflow:hidden;
      opacity:0;
      transform:translateY(-8px);
      pointer-events:none;
      transition:opacity 120ms ease, transform 120ms ease;
      z-index:2;
    }

    .block-wrapper:hover .block-toolbar,
    .block-wrapper:focus-within .block-toolbar{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }

    .block-toolbar button{
      appearance:none;
      border:0;
      background:transparent;
      color:inherit;
      padding:8px 10px;
      display:grid;
      place-items:center;
      cursor:pointer;
      font-size:16px;
    }

    .block-toolbar button:hover,
    .block-toolbar button:focus-visible{
      background:color-mix(in srgb, var(--color-on-surface) 12%, transparent);
    }

    .add-slot{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:var(--spacing-sm) 0;
    }

    .add-slot button{
      border:1px dashed color-mix(in srgb, var(--color-text-secondary) 40%, transparent);
      background:color-mix(in srgb, var(--color-paper) 60%, transparent);
      color:color-mix(in srgb, var(--color-text-secondary) 80%, transparent);
      border-radius:999px;
      padding:6px 14px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:transform 120ms ease, box-shadow 120ms ease;
    }

    .add-slot button:hover,
    .add-slot button:focus-visible{
      transform:translateY(-1px);
      box-shadow:var(--shadow-sm);
    }

    .ig-footer{
      border-top:2px solid var(--color-paper-border);
      display:flex;
      justify-content:space-between;
      gap:var(--spacing-md);
      padding-top:var(--spacing-sm);
      color:var(--color-text-secondary);
    }

    .fab{
      position:fixed;
      right:clamp(16px, 5vw, 42px);
      bottom:clamp(16px, 6vh, 48px);
      width:var(--fab-size);
      height:var(--fab-size);
      border-radius:999px;
      border:none;
      background:var(--color-accent);
      color:var(--color-on-accent);
      font-size:28px;
      display:grid;
      place-items:center;
      box-shadow:var(--shadow-md);
      cursor:pointer;
      z-index:60;
    }

    .fab:hover{filter:brightness(1.08)}
    .fab:focus-visible{outline:3px solid var(--color-on-accent)}

    .microbar{
      position:fixed;
      top:clamp(12px, 4vw, 28px);
      right:clamp(12px, 4vw, 32px);
      display:flex;
      gap:8px;
      background:color-mix(in srgb, var(--color-background-elevated) 96%, transparent);
      padding:6px;
      border-radius:999px;
      border:1px solid color-mix(in srgb, var(--color-on-background) 14%, transparent);
      backdrop-filter: blur(8px);
      box-shadow:var(--shadow-md);
      z-index:70;
    }

    .microbar button{
      width:var(--toolbar-size);
      height:var(--toolbar-size);
      border-radius:999px;
      border:none;
      background:color-mix(in srgb, var(--color-background) 20%, transparent);
      color:var(--color-on-background);
      display:grid;
      place-items:center;
      font-size:18px;
      cursor:pointer;
      transition:transform 120ms ease, background 120ms ease;
    }

    .microbar button:hover,
    .microbar button:focus-visible{
      background:color-mix(in srgb, var(--color-on-background) 20%, transparent);
      transform:translateY(-1px);
    }

    .popover{
      position:fixed;
      z-index:80;
      background:var(--color-surface);
      color:var(--color-on-surface);
      border-radius:var(--radius-md);
      border:1px solid var(--color-surface-border);
      box-shadow:var(--shadow-md);
      padding:var(--spacing-sm);
      display:flex;
      flex-direction:column;
      gap:var(--spacing-xs);
      min-width:220px;
    }

    .popover button{
      border:none;
      background:transparent;
      color:inherit;
      text-align:left;
      padding:var(--spacing-sm);
      border-radius:var(--radius-sm);
      cursor:pointer;
    }

    .popover button:hover,
    .popover button:focus-visible{
      background:color-mix(in srgb, var(--color-on-surface) 16%, transparent);
    }

    dialog.overlay,
    .overlay{
      position:fixed;
      inset:0;
      background:color-mix(in srgb, rgba(7,20,32,0.82) 88%, rgba(7,20,32,0.82));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:clamp(16px, 5vw, 48px);
      z-index:100;
    }

    .overlay[hidden]{display:none}

    .panel-card{
      width:min(540px, 100%);
      max-height:90vh;
      overflow:auto;
      background:var(--color-surface);
      color:var(--color-on-surface);
      border-radius:var(--radius-lg);
      padding:var(--spacing-xl);
      display:flex;
      flex-direction:column;
      gap:var(--spacing-md);
      box-shadow:var(--shadow-lg);
    }

    .panel-card header h2{
      margin:0;
      font-family:var(--font-heading);
      font-size:22px;
    }

    .panel-card label{
      display:block;
      font-size:13px;
      margin-bottom:4px;
      font-weight:600;
    }

    .panel-card input,
    .panel-card textarea,
    .panel-card select{
      width:100%;
      border-radius:var(--radius-sm);
      border:1px solid var(--control-border);
      background:var(--control-background);
      color:var(--control-text);
      padding:var(--spacing-sm);
      font:inherit;
    }

    .panel-card textarea{min-height:120px; resize:vertical}

    .panel-card .actions{
      display:flex;
      justify-content:flex-end;
      gap:var(--spacing-sm);
    }

    .panel-card button{
      border:none;
      border-radius:var(--radius-sm);
      padding:var(--spacing-sm) var(--spacing-md);
      font-weight:600;
      cursor:pointer;
    }

    .panel-card button.primary{background:var(--color-accent); color:var(--color-on-accent)}
    .panel-card button.secondary{background:transparent; color:var(--color-on-surface); border:1px solid color-mix(in srgb, var(--color-on-surface) 18%, transparent)}

    .toast-container{position:fixed; bottom:var(--spacing-xl); right:var(--spacing-xl); display:flex; flex-direction:column; gap:var(--spacing-sm); z-index:120}
    .toast{background:var(--color-surface); color:var(--color-on-surface); border-radius:var(--radius-md); border:1px solid var(--color-surface-border); padding:var(--spacing-sm) var(--spacing-md); box-shadow:var(--shadow-md); display:flex; flex-direction:column; gap:var(--spacing-xs); max-width:320px}
    .toast strong{font-family:var(--font-heading); font-size:14px}
    .toast-actions{display:flex; gap:var(--spacing-xs); justify-content:flex-end}
    .toast-actions button{border:none; border-radius:var(--radius-sm); padding:var(--spacing-xs) var(--spacing-sm); cursor:pointer; background:color-mix(in srgb, var(--color-on-surface) 8%, transparent); color:var(--color-on-surface); font-weight:600}
    .toast-actions button.primary{background:var(--color-accent); color:var(--color-on-accent)}

    .palette{position:fixed; inset:0; background:color-mix(in srgb, rgba(7,20,32,0.78) 100%, rgba(7,20,32,0.78)); display:flex; justify-content:center; align-items:flex-start; padding:clamp(16px, 5vw, 60px); z-index:200}
    .palette[hidden]{display:none}
    .palette-card{width:min(520px, 100%); border-radius:var(--radius-lg); background:var(--color-surface); color:var(--color-on-surface); box-shadow:var(--shadow-lg); display:flex; flex-direction:column; gap:var(--spacing-sm); padding:var(--spacing-lg)}
    .palette-card input{border-radius:var(--radius-sm); border:1px solid var(--control-border); padding:var(--spacing-sm); background:var(--control-background); color:var(--control-text)}
    .palette-card ul{list-style:none; margin:0; padding:0; display:flex; flex-direction:column; max-height:50vh; overflow:auto; gap:4px}
    .palette-card button{width:100%; border:none; padding:10px; border-radius:var(--radius-sm); background:transparent; color:inherit; text-align:left; cursor:pointer}
    .palette-card button:hover,
    .palette-card button:focus-visible{background:color-mix(in srgb, var(--color-on-surface) 14%, transparent)}

    .imgbox{display:block; width:100%; position:relative; overflow:hidden}
    .imgbox::before{content:""; display:block; padding-top:var(--img-aspect, 56%)}
    .imgbox img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}

    .img-actions{display:flex; gap:var(--spacing-xs); flex-wrap:wrap}

    .img-actions button{border:none; border-radius:var(--radius-sm); background:color-mix(in srgb, var(--color-on-surface) 14%, transparent); color:var(--color-on-surface); padding:var(--spacing-xs) var(--spacing-sm); cursor:pointer}

    .visually-hidden{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}

    @media (max-width: 900px){
      .ig-grid{grid-template-columns:1fr}
      .microbar{left:50%; right:auto; transform:translateX(-50%)}
      .infographic{min-height:auto}
    }

    @media print{
      body{background:#fff}
      .microbar, .fab, .toast-container, .palette{display:none !important}
      .workspace{padding:0}
      .infographic{box-shadow:none; border-radius:0; width:100%; min-height:auto}
    }
  </style>
</head>
<body>
  <div class="microbar" role="toolbar" aria-label="Acciones globales">
    <button type="button" id="saveButton" title="Guardar (Ctrl/Cmd+S)">💾</button>
    <button type="button" id="loadButton" title="Cargar (Ctrl/Cmd+O)">📂</button>
    <button type="button" id="printButton" title="Imprimir (Ctrl/Cmd+P)">🖨️</button>
    <button type="button" id="shuffleButton" title="Barajar (R)">🔀</button>
    <button type="button" id="paletteButton" title="Paleta de comandos (Ctrl/Cmd+K)">⌨️</button>
  </div>

  <main class="workspace">
    <article class="infographic" id="infographic" aria-live="polite">
      <header class="ig-header">
        <h1 id="title" data-editable contenteditable="true" spellcheck="true">Título de ejemplo</h1>
        <h2 id="subtitle" data-editable contenteditable="true" spellcheck="true">Un subtítulo descriptivo</h2>
      </header>
      <section class="ig-grid" id="ig-grid" tabindex="-1" aria-label="Lienzo de bloques"></section>
      <footer class="ig-footer">
        <span id="footerL" data-editable contenteditable="true">Autor / Fuente</span>
        <span id="footerR" data-editable contenteditable="true">Oct 2025</span>
      </footer>
    </article>
  </main>

  <button class="fab" id="fabAdd" title="Añadir bloque">＋</button>

  <div class="overlay" id="blockOverlay" hidden aria-modal="true" role="dialog">
    <div class="panel-card" role="document">
      <header>
        <h2 id="overlayTitle">Editar bloque</h2>
      </header>
      <form id="blockForm"></form>
      <div class="actions">
        <button type="button" class="secondary" id="overlayCancel">Cancelar</button>
        <button type="submit" form="blockForm" class="primary">Guardar cambios</button>
      </div>
    </div>
  </div>

  <div class="palette" id="commandPalette" hidden>
    <div class="palette-card" role="dialog" aria-modal="true">
      <label class="visually-hidden" for="paletteSearch">Buscar comando</label>
      <input id="paletteSearch" type="search" placeholder="Escribe un comando o un bloque…" autocomplete="off" />
      <ul id="paletteResults" role="listbox" aria-label="Comandos"></ul>
    </div>
  </div>

  <input type="file" id="loadInput" accept="application/json" hidden />

  <script type="module">
    import { themePacks, defaultThemeId } from './theme-packs.js';

    const root = document.documentElement;
    const grid = document.getElementById('ig-grid');
    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const footerLEl = document.getElementById('footerL');
    const footerREl = document.getElementById('footerR');
    const overlay = document.getElementById('blockOverlay');
    const blockForm = document.getElementById('blockForm');
    const overlayCancel = document.getElementById('overlayCancel');
    const overlayTitle = document.getElementById('overlayTitle');
    const loadInput = document.getElementById('loadInput');
    const palette = document.getElementById('commandPalette');
    const paletteSearch = document.getElementById('paletteSearch');
    const paletteResults = document.getElementById('paletteResults');

    const STORAGE_KEY = 'infografia-autosave-v2';
    const AUTO_SAVE_DELAY = 1400;

    const LIST_DEFAULT_STYLE = Object.freeze({
      type:'bulleted',
      marker:'bullet',
      gap:'md',
      indent:'md',
      align:'start',
    });

    const state = {
      title:'Título de ejemplo',
      subtitle:'Un subtítulo descriptivo',
      footerL:'Autor / Fuente',
      footerR:'Oct 2025',
      themeId: defaultThemeId,
      theme: null,
      blocks: [],
      history: [],
    };

    let autoSaveTimer = null;
    let openedBlockId = null;
    let paletteActiveIndex = -1;
    let suppressAutoSave = false;
    let lastAutoSaveToast = null;
    let draggingBlockId = null;

    const commands = [];

    function ensureToastContainer(){
      let container = document.querySelector('.toast-container');
      if(!container){
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
      }
      return container;
    }

    function showToast(message, actions = [], options = {}){
      const container = ensureToastContainer();
      const toast = document.createElement('div');
      toast.className = 'toast';
      const label = document.createElement('strong');
      label.textContent = message;
      toast.appendChild(label);

      if(actions.length){
        const bar = document.createElement('div');
        bar.className = 'toast-actions';
        for(const action of actions){
          const button = document.createElement('button');
          button.textContent = action.label;
          if(action.primary) button.classList.add('primary');
          button.addEventListener('click', ()=>{
            try{
              action.onClick?.();
            } finally {
              dismiss();
            }
          });
          bar.appendChild(button);
        }
        toast.appendChild(bar);
      }

      container.appendChild(toast);

      const timeout = typeof options.duration === 'number' ? options.duration : 6000;
      let timerId = null;

      const dismiss = ()=>{
        if(timerId) clearTimeout(timerId);
        toast.remove();
      };

      if(timeout > 0){
        timerId = setTimeout(dismiss, timeout);
      }

      return { dismiss };
    }

    function clearDropIndicators(){
      document
        .querySelectorAll('.block-wrapper.drop-before, .block-wrapper.drop-after')
        .forEach((element)=>{
          element.classList.remove('drop-before');
          element.classList.remove('drop-after');
        });
    }

    function cleanListItems(items){
      const normalized = [];
      let previousEmpty = false;
      for(const raw of items || []){
        const text = typeof raw === 'string' ? raw.trim() : '';
        if(!text){
          if(previousEmpty) continue;
          previousEmpty = true;
          normalized.push('');
        } else {
          normalized.push(text);
          previousEmpty = false;
        }
      }
      while(normalized.length && !normalized[0]) normalized.shift();
      while(normalized.length && !normalized[normalized.length-1]) normalized.pop();
      return normalized;
    }

    function parseBulletedSequence(lines){
      const items = [];
      let markerSymbol = null;
      let capturing = false;
      for(const line of lines){
        const trimmed = line.trim();
        if(!trimmed){
          if(capturing && items.length >= 2) break;
          continue;
        }
        const match = trimmed.match(/^([-*•])\s+(.*)$/);
        if(match){
          capturing = true;
          if(!markerSymbol) markerSymbol = match[1];
          items.push(match[2]);
        } else if(capturing){
          break;
        }
      }
      const normalized = cleanListItems(items);
      if(normalized.length >= 2){
        const marker = markerSymbol === '-' ? 'dash' : 'bullet';
        return { type:'bulleted', marker, items: normalized };
      }
      return null;
    }

    function parseNumberedSequence(lines){
      const items = [];
      let capturing = false;
      for(const line of lines){
        const trimmed = line.trim();
        if(!trimmed){
          if(capturing && items.length >= 2) break;
          continue;
        }
        const match = trimmed.match(/^(\d+)[\.\)ºª]?\s+(.*)$/i);
        if(match){
          const number = parseInt(match[1], 10);
          if(!capturing){
            if(number !== 1) continue;
            capturing = true;
            items.push(match[2]);
          } else {
            if(items.length === 1 && number !== 2){
              return null;
            }
            items.push(match[2]);
          }
        } else if(capturing){
          break;
        }
      }
      const normalized = cleanListItems(items);
      if(normalized.length >= 2){
        return { type:'numbered', marker:'decimal', items: normalized };
      }
      return null;
    }

    function serializeListToText(items, type, marker){
      const prefix = type === 'numbered' ? (index)=>`${index + 1}. ` : ()=> marker === 'dash' ? '- ' : '• ';
      return (items || []).map((value, index)=>`${prefix(index)}${value}`).join('\n');
    }

    function hexToRgb(color){
      if(typeof color !== 'string') return null;
      const hex = color.trim().replace('#','');
      const normalized = hex.length === 3 ? hex.split('').map((c)=>c + c).join('') : hex;
      if(normalized.length !== 6) return null;
      const num = parseInt(normalized, 16);
      if(Number.isNaN(num)) return null;
      return {
        r:(num >> 16) & 255,
        g:(num >> 8) & 255,
        b:num & 255,
      };
    }

    function relativeLuminance(color){
      const rgb = typeof color === 'string' ? hexToRgb(color) : color;
      if(!rgb) return 0;
      const transform = (value)=>{
        const channel = value / 255;
        return channel <= 0.03928 ? channel / 12.92 : Math.pow((channel + 0.055) / 1.055, 2.4);
      };
      const r = transform(rgb.r);
      const g = transform(rgb.g);
      const b = transform(rgb.b);
      return 0.2126 * r + 0.7152 * g + 0.0722 * b;
    }

    function contrastRatio(colorA, colorB){
      const lumA = relativeLuminance(colorA);
      const lumB = relativeLuminance(colorB);
      const brightest = Math.max(lumA, lumB);
      const darkest = Math.min(lumA, lumB);
      return (brightest + 0.05) / (darkest + 0.05);
    }

    function chooseReadableText(background, ...candidates){
      let best = candidates[0] || '#000000';
      let bestRatio = 0;
      for(const candidate of candidates){
        if(!candidate) continue;
        const ratio = contrastRatio(candidate, background);
        if(ratio > bestRatio){
          best = candidate;
          bestRatio = ratio;
        }
      }
      return best;
    }

    function toRgba(color, alpha){
      const rgb = hexToRgb(color);
      if(!rgb) return color;
      const a = typeof alpha === 'number' ? Math.min(Math.max(alpha, 0), 1) : 1;
      return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${a})`;
    }

    function mixColors(colorA, colorB, amount = 0.5){
      const a = hexToRgb(colorA);
      const b = hexToRgb(colorB);
      if(!a || !b) return colorA;
      const ratio = Math.min(Math.max(amount, 0), 1);
      const r = Math.round(a.r + (b.r - a.r) * ratio);
      const g = Math.round(a.g + (b.g - a.g) * ratio);
      const bl = Math.round(a.b + (b.b - a.b) * ratio);
      return `#${[r,g,bl].map((v)=>v.toString(16).padStart(2,'0')).join('')}`;
    }

    function applySpacing(spacing){
      const tokens = ['--spacing-xs','--spacing-sm','--spacing-md','--spacing-lg','--spacing-xl','--spacing-2xl','--spacing-3xl'];
      const values = Array.isArray(spacing?.scale) ? spacing.scale : [];
      tokens.forEach((token, index)=>{
        const value = values[index];
        if(typeof value === 'number'){
          root.style.setProperty(token, `${value}px`);
        } else if(typeof value === 'string'){
          root.style.setProperty(token, value);
        }
      });
      if(spacing?.density){
        root.style.setProperty('--spacing-density', spacing.density);
      }
    }

    function applyShadows(shadows){
      const list = Array.isArray(shadows) ? shadows : [];
      const fallback = list[list.length - 1] || '0 12px 34px rgba(0,0,0,0.18)';
      root.style.setProperty('--shadow-sm', list[0] || fallback);
      root.style.setProperty('--shadow-md', list[1] || fallback);
      root.style.setProperty('--shadow-lg', list[2] || fallback);
    }

    function applyTheme(theme){
      if(!theme) return;
      state.themeId = theme.id;
      state.theme = theme;
      const palette = theme.palette;
      root.style.setProperty('--color-background', palette.background);
      root.style.setProperty('--color-accent', palette.accent);
      root.style.setProperty('--color-accent-strong', palette.accentStrong);
      root.style.setProperty('--color-surface', palette.surface);
      root.style.setProperty('--color-paper', palette.paper);
      root.style.setProperty('--color-text-primary', palette.textPrimary);
      root.style.setProperty('--color-text-secondary', palette.textSecondary);

      const surfaceText = chooseReadableText(palette.surface, palette.textPrimary, palette.paper, '#ffffff');
      const backgroundText = chooseReadableText(palette.background, palette.paper, palette.textPrimary, '#ffffff');
      const accentText = chooseReadableText(palette.accent, palette.paper, palette.textPrimary, '#ffffff');
      const accentStrongText = chooseReadableText(palette.accentStrong, palette.paper, palette.textPrimary, '#ffffff');

      root.style.setProperty('--color-on-surface', surfaceText);
      root.style.setProperty('--color-on-background', backgroundText);
      root.style.setProperty('--color-on-accent', accentText);
      root.style.setProperty('--color-on-accent-strong', accentStrongText);

      const surfaceLum = relativeLuminance(palette.surface);
      const paperLum = relativeLuminance(palette.paper);
      const surfaceBorder = surfaceLum < 0.5 ? 'rgba(255,255,255,0.18)' : 'rgba(0,0,0,0.15)';
      const paperBorder = paperLum > 0.6 ? 'rgba(0,0,0,0.12)' : 'rgba(255,255,255,0.16)';
      const controlBackground = surfaceLum < 0.5 ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.05)';
      const controlBorder = surfaceLum < 0.5 ? 'rgba(255,255,255,0.18)' : 'rgba(0,0,0,0.12)';

      root.style.setProperty('--color-surface-border', surfaceBorder);
      root.style.setProperty('--color-paper-border', paperBorder);
      root.style.setProperty('--control-background', controlBackground);
      root.style.setProperty('--control-border', controlBorder);
      root.style.setProperty('--control-text', surfaceText);
      root.style.setProperty('--color-background-elevated', toRgba(palette.background, 0.9));

      const mutedPaper = mixColors(palette.paper, palette.accent, 0.08);
      root.style.setProperty('--color-paper-muted', mutedPaper);

      if(theme.typography){
        if(theme.typography.heading) root.style.setProperty('--font-heading', theme.typography.heading);
        if(theme.typography.body) root.style.setProperty('--font-body', theme.typography.body);
        if(Number.isFinite(theme.typography.weightHeading)) root.style.setProperty('--font-weight-heading', `${theme.typography.weightHeading}`);
        if(Number.isFinite(theme.typography.weightBody)) root.style.setProperty('--font-weight-body', `${theme.typography.weightBody}`);
      }

      if(theme.radii){
        if(theme.radii.none) root.style.setProperty('--radius-none', theme.radii.none);
        if(theme.radii.sm) root.style.setProperty('--radius-sm', theme.radii.sm);
        if(theme.radii.md) root.style.setProperty('--radius-md', theme.radii.md);
        if(theme.radii.lg) root.style.setProperty('--radius-lg', theme.radii.lg);
      }

      applySpacing(theme.spacing);
      applyShadows(theme.shadows);

      root.style.removeProperty('--size-row-unit');
      root.style.removeProperty('--grid-column-gap');
      if(theme.grid){
        if(Number.isFinite(theme.grid.rowUnit)){
          root.style.setProperty('--size-row-unit', `${theme.grid.rowUnit}px`);
        }
        if(Number.isFinite(theme.grid.columnGap)){
          root.style.setProperty('--grid-column-gap', `${theme.grid.columnGap}px`);
        }
        if(Number.isFinite(theme.grid.columns)){
          grid.style.setProperty('--cols', theme.grid.columns);
        }
      }

      const b = theme.components?.block;
      const blockVars = [
        '--block-background',
        '--block-border-width',
        '--block-border-style',
        '--block-border-color',
        '--block-radius',
        '--block-shadow',
        '--block-padding',
        '--block-ink-background',
        '--block-ink-text',
      ];
      blockVars.forEach((prop)=> root.style.removeProperty(prop));
      if(b){
        if(b.background){
          const map = {
            transparent:'transparent',
            paper:'var(--color-paper)',
            'paper-muted':'var(--color-paper-muted)',
            surface:'var(--color-surface)',
            accent:'var(--color-accent)',
          };
          root.style.setProperty('--block-background', map[b.background] || b.background);
        }
        if(Number.isFinite(b.borderWidth)) root.style.setProperty('--block-border-width', `${b.borderWidth}px`);
        if(b.borderStyle) root.style.setProperty('--block-border-style', b.borderStyle);
        if(b.borderColor){
          const autoColor = getComputedStyle(root).getPropertyValue('--color-paper-border').trim();
          root.style.setProperty('--block-border-color', b.borderColor === 'auto' ? autoColor : b.borderColor);
        }
        if(b.radius){
          const asVar = `var(--radius-${b.radius})`;
          root.style.setProperty('--block-radius', /^(none|sm|md|lg)$/.test(b.radius) ? asVar : b.radius);
        }
        if(b.shadow){
          const mapSh = { none:'none', sm:'var(--shadow-sm)', md:'var(--shadow-md)', lg:'var(--shadow-lg)' };
          root.style.setProperty('--block-shadow', mapSh[b.shadow] || b.shadow);
        }
        if(b.paddingToken){
          root.style.setProperty('--block-padding', `var(--spacing-${b.paddingToken})`);
        }
        if(b.darkFillBackground){
          const mapDark = { accentStrong:'var(--color-accent-strong)', surface:'var(--color-surface)' };
          root.style.setProperty('--block-ink-background', mapDark[b.darkFillBackground] || b.darkFillBackground);
        }
        if(b.darkFillText){
          const mapDarkText = { onAccentStrong:'var(--color-on-accent-strong)', onSurface:'var(--color-on-surface)' };
          root.style.setProperty('--block-ink-text', mapDarkText[b.darkFillText] || b.darkFillText);
        }
      }
    }

    function resolveBlockTone(style){
      const tone = style?.tone === 'dark' ? 'dark' : 'light';
      return tone;
    }

    function normalizeTextBlock(block){
      if(!block || typeof block !== 'object') return null;
      const tone = resolveBlockTone(block.style);
      const importance = block.importance === 'destacado' ? 'destacado' : 'auto';
      const kind = block.kind === 'list' ? 'list' : 'text';
      const base = {
        ...block,
        title: typeof block.title === 'string' ? block.title : '',
        text: typeof block.text === 'string' ? block.text : '',
        style:{ tone },
        importance,
        kind,
      };
      if(kind === 'list'){
        const listStyle = { ...LIST_DEFAULT_STYLE, ...(block.style?.list || {}) };
        if(listStyle.type !== 'numbered') listStyle.type = 'bulleted';
        if(listStyle.marker !== 'dash' && listStyle.marker !== 'decimal') listStyle.marker = 'bullet';
        base.style.list = listStyle;
        const items = cleanListItems(block.content?.items?.map((item)=>item?.text || '') || []);
        base.content = { items: items.map((text)=>({ text })) };
        if(!base.text && items.length){
          base.text = serializeListToText(items, listStyle.type, listStyle.marker);
        }
      }
      return base;
    }

    function createDefaultBlocks(){
      return [
        normalizeTextBlock({
          id:crypto.randomUUID(),
          type:'text',
          title:'Bloque destacado',
          text:'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec commodo elit vitae sem facilisis, sed luctus neque molestie.',
          kind:'text',
          style:{ tone:'dark' },
          importance:'destacado',
        }),
        normalizeTextBlock({
          id:crypto.randomUUID(),
          type:'text',
          title:'Puntos clave',
          kind:'list',
          text:'• Primer dato relevante\n• Segundo dato interesante\n• Tercer idea memorable',
          style:{ tone:'light', list:{ type:'bulleted', marker:'bullet', gap:'sm', indent:'md', align:'start' } },
          content:{ items:[{ text:'Primer dato relevante' }, { text:'Segundo dato interesante' }, { text:'Tercer idea memorable' }] },
        }),
      ].filter(Boolean);
    }

    function loadState(data){
      if(!data) return;
      state.title = typeof data.title === 'string' ? data.title : state.title;
      state.subtitle = typeof data.subtitle === 'string' ? data.subtitle : state.subtitle;
      state.footerL = typeof data.footerL === 'string' ? data.footerL : state.footerL;
      state.footerR = typeof data.footerR === 'string' ? data.footerR : state.footerR;
      const theme = themePacks.find((pack)=>pack.id === data.themeId) || themePacks.find((pack)=>pack.id === defaultThemeId) || themePacks[0];
      applyTheme(theme);
      const blocks = Array.isArray(data.blocks) ? data.blocks : [];
      state.blocks = blocks.map((block)=>{
        if(block.type === 'text') return normalizeTextBlock(block);
        if(block.type === 'img'){
          return {
            id:block.id || crypto.randomUUID(),
            type:'img',
            title: typeof block.title === 'string' ? block.title : '',
            alt: typeof block.alt === 'string' ? block.alt : '',
            src: block.src || '',
            ratio: Number(block.ratio) || 16/9,
            style: block.style || {},
          };
        }
        return null;
      }).filter(Boolean);
      if(!state.blocks.length){
        state.blocks = createDefaultBlocks();
      }
      suppressAutoSave = true;
      applyStateToDom();
      suppressAutoSave = false;
    }

    function applyStateToDom(){
      titleEl.textContent = state.title;
      subtitleEl.textContent = state.subtitle;
      footerLEl.textContent = state.footerL;
      footerREl.textContent = state.footerR;
      renderBlocks();
    }

    function saveToLocal(){
      const payload = JSON.stringify({
        title: state.title,
        subtitle: state.subtitle,
        footerL: state.footerL,
        footerR: state.footerR,
        themeId: state.themeId,
        blocks: state.blocks,
      });
      localStorage.setItem(STORAGE_KEY, payload);
    }

    function scheduleAutoSave(){
      if(suppressAutoSave) return;
      if(autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(()=>{
        saveToLocal();
        if(lastAutoSaveToast){
          lastAutoSaveToast.dismiss?.();
        }
        lastAutoSaveToast = showToast('Guardado automáticamente');
      }, AUTO_SAVE_DELAY);
    }

    function createBlockElement(block, index){
      const wrapper = document.createElement('div');
      wrapper.className = 'block-wrapper';
      wrapper.dataset.blockId = block.id;
      wrapper.tabIndex = -1;

      const toolbar = document.createElement('div');
      toolbar.className = 'block-toolbar';

      const handle = document.createElement('button');
      handle.type = 'button';
      handle.className = 'handle';
      handle.title = 'Mover (arrastrar o Alt+Flechas)';
      handle.textContent = '↕';
      handle.setAttribute('aria-label', 'Mover bloque');
      handle.draggable = true;
      handle.addEventListener('dragstart', (event)=>{
        draggingBlockId = block.id;
        if(event.dataTransfer){
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', block.id);
        }
        wrapper.classList.add('dragging');
      });
      handle.addEventListener('dragend', ()=>{
        wrapper.classList.remove('dragging');
        draggingBlockId = null;
        clearDropIndicators();
      });
      toolbar.appendChild(handle);

      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.textContent = '✏️';
      editBtn.title = 'Editar bloque (E)';
      editBtn.addEventListener('click', ()=>openBlockOverlay(block.id));
      toolbar.appendChild(editBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = '🗑️';
      deleteBtn.title = 'Eliminar bloque (Supr)';
      deleteBtn.addEventListener('click', ()=>removeBlock(block.id));
      toolbar.appendChild(deleteBtn);

      wrapper.appendChild(toolbar);

      const article = document.createElement('article');
      article.className = 'block';
      article.dataset.kind = block.kind || block.type;
      if(block.type === 'text' && resolveBlockTone(block.style) === 'dark'){
        article.classList.add('fill-ink');
      }
      article.tabIndex = 0;
      article.addEventListener('focus', ()=> wrapper.classList.add('focused'));
      article.addEventListener('blur', ()=> wrapper.classList.remove('focused'));
      article.addEventListener('keydown', (event)=>handleBlockKey(event, index));

      if(block.type === 'text'){
        const pad = document.createElement('div');
        pad.className = 'pad';

        const title = document.createElement('h3');
        title.dataset.editable = '';
        title.contentEditable = 'true';
        title.spellcheck = true;
        title.textContent = block.title || 'Título del bloque';
        title.addEventListener('input', ()=>{
          block.title = title.textContent.trim();
          scheduleAutoSave();
        });
        pad.appendChild(title);

        if(block.kind === 'list'){
          const list = document.createElement(block.style?.list?.type === 'numbered' ? 'ol' : 'ul');
          list.className = 'list';
          list.dataset.type = block.style?.list?.type || 'bulleted';
          list.dataset.marker = block.style?.list?.marker || 'bullet';
          list.dataset.listAlign = block.style?.list?.align || 'start';
          list.contentEditable = 'true';
          list.spellcheck = true;
          const items = block.content?.items?.length ? block.content.items : (block.text ? block.text.split('\n').map((text)=>({ text })) : []);
          if(items.length){
            for(const item of items){
              const li = document.createElement('li');
              li.textContent = item?.text || '';
              list.appendChild(li);
            }
          } else {
            const li = document.createElement('li');
            li.textContent = 'Ítem de lista';
            list.appendChild(li);
          }

          list.addEventListener('input', ()=>{
            const values = Array.from(list.children).map((li)=>li.textContent || '');
            const normalized = cleanListItems(values);
            block.content = { items: normalized.map((text)=>({ text })) };
            block.text = serializeListToText(normalized, block.style?.list?.type || 'bulleted', block.style?.list?.marker || 'bullet');
            scheduleAutoSave();
          });

          pad.appendChild(list);
        } else {
          const paragraph = document.createElement('p');
          paragraph.dataset.editable = '';
          paragraph.contentEditable = 'true';
          paragraph.spellcheck = true;
          paragraph.innerText = block.text || 'Escribe aquí el contenido del bloque…';
          paragraph.addEventListener('input', ()=>{
            block.text = paragraph.innerText.trim();
            const detection = detectListFromText(block.text);
            if(detection && detection.items.length){
              block.kind = 'list';
              block.style = block.style || {};
              block.style.list = { ...LIST_DEFAULT_STYLE, type:detection.type, marker:detection.marker };
              block.content = { items:detection.items.map((text)=>({ text })) };
              renderBlocks();
              return;
            }
            scheduleAutoSave();
          });
          pad.appendChild(paragraph);
        }

        article.appendChild(pad);
      } else if(block.type === 'img'){
        const pad = document.createElement('div');
        pad.className = 'pad';
        const title = document.createElement('h3');
        title.dataset.editable = '';
        title.contentEditable = 'true';
        title.textContent = block.title || 'Título de la imagen';
        title.addEventListener('input', ()=>{
          block.title = title.textContent.trim();
          scheduleAutoSave();
        });
        pad.appendChild(title);

        const imgbox = document.createElement('a');
        imgbox.className = 'imgbox';
        imgbox.style.setProperty('--img-aspect', `${100 / (block.ratio || (16/9))}%`);
        imgbox.href = block.src || '#';
        imgbox.target = '_blank';
        imgbox.rel = 'noopener';
        const img = document.createElement('img');
        img.src = block.src || 'https://via.placeholder.com/800x450?text=Imagen';
        img.alt = block.alt || '';
        imgbox.appendChild(img);
        pad.appendChild(imgbox);

        const actions = document.createElement('div');
        actions.className = 'img-actions';
        const changeBtn = document.createElement('button');
        changeBtn.type = 'button';
        changeBtn.textContent = 'Cambiar imagen';
        changeBtn.addEventListener('click', ()=> selectImageForBlock(block.id));
        actions.appendChild(changeBtn);

        const cropBtn = document.createElement('button');
        cropBtn.type = 'button';
        cropBtn.textContent = 'Ajustar ratio';
        cropBtn.addEventListener('click', ()=> openBlockOverlay(block.id));
        actions.appendChild(cropBtn);

        pad.appendChild(actions);
        article.appendChild(pad);
      }

      wrapper.appendChild(article);

      wrapper.addEventListener('dragover', (event)=>{
        if(!draggingBlockId || draggingBlockId === block.id) return;
        event.preventDefault();
        if(event.dataTransfer){
          event.dataTransfer.dropEffect = 'move';
        }
        document
          .querySelectorAll('.block-wrapper.drop-before, .block-wrapper.drop-after')
          .forEach((element)=>{
            if(element !== wrapper){
              element.classList.remove('drop-before');
              element.classList.remove('drop-after');
            }
          });
        const rect = wrapper.getBoundingClientRect();
        const before = event.clientY < rect.top + rect.height / 2;
        wrapper.classList.toggle('drop-before', before);
        wrapper.classList.toggle('drop-after', !before);
      });

      wrapper.addEventListener('dragleave', ()=>{
        wrapper.classList.remove('drop-before');
        wrapper.classList.remove('drop-after');
      });

      wrapper.addEventListener('drop', (event)=>{
        if(!draggingBlockId || draggingBlockId === block.id) return;
        event.preventDefault();
        const draggedIndex = state.blocks.findIndex((b)=>b.id === draggingBlockId);
        if(draggedIndex < 0) return;
        const rect = wrapper.getBoundingClientRect();
        const before = event.clientY < rect.top + rect.height / 2;
        const targetIndex = before ? index : index + 1;
        draggingBlockId = null;
        clearDropIndicators();
        moveBlock(draggedIndex, targetIndex);
      });

      wrapper.addEventListener('focus', ()=>{
        wrapper.classList.add('focused');
      });
      wrapper.addEventListener('blur', ()=>{
        wrapper.classList.remove('focused');
      }, true);

      return wrapper;
    }

    function detectListFromText(text){
      const lines = (text || '').split(/\r?\n/);
      const numbered = parseNumberedSequence(lines);
      if(numbered) return numbered;
      const bulleted = parseBulletedSequence(lines);
      if(bulleted) return bulleted;
      return null;
    }

    function renderBlocks(){
      grid.innerHTML = '';
      const addSlot = (index)=>{
        const slot = document.createElement('div');
        slot.className = 'add-slot';
        const button = document.createElement('button');
        button.type = 'button';
        button.innerHTML = '＋ Añadir bloque';
        button.addEventListener('click', (event)=>{
          openAddMenu(event.currentTarget, index);
        });
        slot.appendChild(button);
        grid.appendChild(slot);
      };

      addSlot(0);
      state.blocks.forEach((block, index)=>{
        const element = createBlockElement(block, index);
        grid.appendChild(element);
        addSlot(index + 1);
      });
      scheduleAutoSave();
    }

    function openAddMenu(anchor, index){
      closePopovers();
      const rect = anchor.getBoundingClientRect();
      const popover = document.createElement('div');
      popover.className = 'popover';
      const addText = document.createElement('button');
      addText.type = 'button';
      addText.textContent = 'Texto';
      addText.addEventListener('click', ()=>{
        insertBlock(createTextBlock(), index);
        closePopovers();
      });
      popover.appendChild(addText);
      const addImage = document.createElement('button');
      addImage.type = 'button';
      addImage.textContent = 'Imagen';
      addImage.addEventListener('click', ()=>{
        insertBlock(createImageBlock(), index);
        closePopovers();
      });
      popover.appendChild(addImage);
      document.body.appendChild(popover);
      requestAnimationFrame(()=>{
        const top = rect.bottom + 8;
        const left = Math.min(rect.left, window.innerWidth - popover.offsetWidth - 12);
        popover.style.top = `${top}px`;
        popover.style.left = `${left}px`;
      });
      document.addEventListener('pointerdown', handleOutsidePopover, { once:true });
    }

    function closePopovers(){
      document.querySelectorAll('.popover').forEach((p)=>p.remove());
    }

    function handleOutsidePopover(event){
      if(!event.target.closest('.popover')){
        closePopovers();
      }
    }

    function createTextBlock(){
      return normalizeTextBlock({
        id:crypto.randomUUID(),
        type:'text',
        title:'Nuevo bloque',
        text:'Escribe aquí…',
        kind:'text',
        style:{ tone:'light' },
      });
    }

    function createImageBlock(){
      return {
        id:crypto.randomUUID(),
        type:'img',
        title:'Nueva imagen',
        src:'https://via.placeholder.com/800x450?text=Imagen',
        alt:'',
        ratio:16/9,
        style:{},
      };
    }

    function insertBlock(block, index){
      state.blocks.splice(index, 0, block);
      renderBlocks();
      scheduleAutoSave();
      showToast('Bloque añadido');
    }

    function removeBlock(id){
      const index = state.blocks.findIndex((block)=>block.id === id);
      if(index < 0) return;
      const [removed] = state.blocks.splice(index, 1);
      renderBlocks();
      const toast = showToast('Bloque eliminado', [
        {
          label:'Deshacer',
          primary:true,
          onClick:()=>{
            state.blocks.splice(index, 0, removed);
            renderBlocks();
          },
        },
      ]);
      scheduleAutoSave();
      return toast;
    }

    function selectImageForBlock(id){
      const block = state.blocks.find((b)=>b.id === id);
      if(!block) return;
      const picker = document.createElement('input');
      picker.type = 'file';
      picker.accept = 'image/*';
      picker.addEventListener('change', ()=>{
        const file = picker.files?.[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          block.src = reader.result;
          renderBlocks();
          scheduleAutoSave();
        };
        reader.readAsDataURL(file);
      });
      picker.click();
    }

    function moveBlock(from, to){
      if(from === to || from < 0 || from >= state.blocks.length) return;
      const [block] = state.blocks.splice(from, 1);
      const target = to > state.blocks.length ? state.blocks.length : to;
      state.blocks.splice(target > from ? target - 1 : target, 0, block);
      renderBlocks();
    }

    function handleBlockKey(event, index){
      const block = state.blocks[index];
      if(!block) return;
      if(event.key === 'Delete' || event.key === 'Backspace' && event.ctrlKey){
        event.preventDefault();
        removeBlock(block.id);
      } else if((event.key === 'ArrowUp' || event.key === 'ArrowDown') && event.altKey){
        event.preventDefault();
        const delta = event.key === 'ArrowUp' ? -1 : 1;
        const target = Math.max(0, Math.min(state.blocks.length, index + delta));
        moveBlock(index, target);
      } else if(event.key.toLowerCase() === 'e'){
        event.preventDefault();
        openBlockOverlay(block.id);
      }
    }

    function openBlockOverlay(id){
      const block = state.blocks.find((b)=>b.id === id);
      if(!block) return;
      openedBlockId = id;
      blockForm.innerHTML = '';
      overlayTitle.textContent = block.type === 'img' ? 'Editar imagen' : 'Editar bloque de texto';
      overlay.hidden = false;
      document.body.style.overflow = 'hidden';

      if(block.type === 'text'){
        buildTextForm(block);
      } else if(block.type === 'img'){
        buildImageForm(block);
      }
    }

    function closeOverlay(){
      overlay.hidden = true;
      document.body.style.overflow = '';
      openedBlockId = null;
    }

    overlayCancel.addEventListener('click', ()=>{
      closeOverlay();
    });

    overlay.addEventListener('click', (event)=>{
      if(event.target === overlay){
        closeOverlay();
      }
    });

    function buildTextForm(block){
      const titleField = createField('Título', 'text', block.title);
      const textarea = createTextarea('Contenido', block.text);
      const toneSelect = createSelect('Estilo', [
        { value:'light', label:'Claro' },
        { value:'dark', label:'Oscuro' },
      ], resolveBlockTone(block.style));
      const importanceSelect = createSelect('Importancia', [
        { value:'auto', label:'Auto' },
        { value:'destacado', label:'Destacado' },
      ], block.importance === 'destacado' ? 'destacado' : 'auto');

      const kindSelect = createSelect('Tipo de bloque', [
        { value:'text', label:'Párrafo' },
        { value:'list', label:'Lista' },
      ], block.kind === 'list' ? 'list' : 'text');

      const listWrapper = document.createElement('div');
      listWrapper.dataset.role = 'list-settings';
      const listType = createSelect('Tipo de lista', [
        { value:'bulleted', label:'Viñetas' },
        { value:'numbered', label:'Numerada' },
      ], block.style?.list?.type === 'numbered' ? 'numbered' : 'bulleted');
      const listMarker = createSelect('Viñeta', [
        { value:'bullet', label:'• redonda' },
        { value:'dash', label:'– guion' },
        { value:'decimal', label:'1. 2. 3.' },
      ], block.style?.list?.marker || 'bullet');
      const listGap = createSelect('Separación', [
        { value:'xs', label:'XS' },
        { value:'sm', label:'SM' },
        { value:'md', label:'MD' },
        { value:'lg', label:'LG' },
      ], block.style?.list?.gap || 'md');
      const listIndent = createSelect('Indentación', [
        { value:'none', label:'Sin sangría' },
        { value:'sm', label:'SM' },
        { value:'md', label:'MD' },
        { value:'lg', label:'LG' },
      ], block.style?.list?.indent || 'md');
      const listAlign = createSelect('Alineación', [
        { value:'start', label:'Inicio' },
        { value:'center', label:'Centro' },
        { value:'end', label:'Fin' },
      ], block.style?.list?.align || 'start');

      listWrapper.append(
        listType.wrapper,
        listMarker.wrapper,
        listGap.wrapper,
        listIndent.wrapper,
        listAlign.wrapper
      );

      const items = document.createElement('div');
      items.style.display = 'flex';
      items.style.flexDirection = 'column';
      items.style.gap = '6px';
      const listItems = block.content?.items?.length ? block.content.items.map((item)=>item?.text || '') : block.text.split('\n');
      const normalized = cleanListItems(listItems.length ? listItems : ['']);
      const renderItems = ()=>{
        items.innerHTML = '';
        normalized.forEach((value, index)=>{
          const field = createField(`Ítem ${index + 1}`, 'text', value);
          field.input.addEventListener('input', ()=>{
            normalized[index] = field.input.value;
          });
          items.appendChild(field.wrapper);
        });
      };
      renderItems();

      const addItemBtn = document.createElement('button');
      addItemBtn.type = 'button';
      addItemBtn.textContent = 'Añadir ítem';
      addItemBtn.className = 'secondary';
      addItemBtn.addEventListener('click', ()=>{
        normalized.push('');
        renderItems();
      });

      blockForm.append(
        titleField.wrapper,
        textarea.wrapper,
        toneSelect.wrapper,
        importanceSelect.wrapper,
        kindSelect.wrapper,
        listWrapper,
        items,
        addItemBtn
      );

      const syncListVisibility = ()=>{
        const kind = kindSelect.input.value === 'list' ? 'list' : 'text';
        listWrapper.style.display = kind === 'list' ? 'flex' : 'none';
        listWrapper.style.flexDirection = 'column';
        listWrapper.style.gap = 'var(--spacing-sm)';
        items.style.display = kind === 'list' ? 'flex' : 'none';
        addItemBtn.style.display = kind === 'list' ? 'inline-flex' : 'none';
      };
      syncListVisibility();
      kindSelect.input.addEventListener('change', syncListVisibility);

      blockForm.onsubmit = (event)=>{
        event.preventDefault();
        block.title = titleField.input.value.trim();
        block.text = textarea.input.value.trim();
        block.style = block.style || {};
        block.style.tone = toneSelect.input.value === 'dark' ? 'dark' : 'light';
        block.importance = importanceSelect.input.value === 'destacado' ? 'destacado' : 'auto';
        const kind = kindSelect.input.value === 'list' ? 'list' : 'text';
        block.kind = kind;
        if(kind === 'list'){
          const itemsValues = cleanListItems(normalized);
          block.content = { items: itemsValues.map((text)=>({ text })) };
          const type = listType.input.value === 'numbered' ? 'numbered' : 'bulleted';
          let marker = listMarker.input.value;
          if(type === 'numbered') marker = 'decimal';
          block.style.list = {
            type,
            marker: marker === 'dash' ? 'dash' : marker === 'decimal' ? 'decimal' : 'bullet',
            gap: listGap.input.value,
            indent: listIndent.input.value,
            align: listAlign.input.value,
          };
          block.text = serializeListToText(itemsValues, block.style.list.type, block.style.list.marker);
        } else {
          block.kind = 'text';
          delete block.content;
          delete block.style?.list;
        }
        closeOverlay();
        renderBlocks();
        scheduleAutoSave();
      };
    }

    function buildImageForm(block){
      const titleField = createField('Título', 'text', block.title);
      const urlField = createField('URL o ruta', 'text', block.src);
      const altField = createField('Texto alternativo', 'text', block.alt);
      const ratioField = createField('Ratio (ancho/alto)', 'number', block.ratio);
      ratioField.input.step = '0.01';
      ratioField.input.min = '0.1';

      const uploadField = document.createElement('div');
      uploadField.className = 'upload-field';
      const label = document.createElement('label');
      label.textContent = 'Subir imagen';
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.addEventListener('change', ()=>{
        const file = input.files?.[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          block.src = reader.result;
          urlField.input.value = block.src;
        };
        reader.readAsDataURL(file);
      });
      uploadField.append(label, input);

      blockForm.append(
        titleField.wrapper,
        urlField.wrapper,
        altField.wrapper,
        ratioField.wrapper,
        uploadField
      );

      blockForm.onsubmit = (event)=>{
        event.preventDefault();
        block.title = titleField.input.value.trim();
        block.src = urlField.input.value.trim();
        block.alt = altField.input.value.trim();
        const ratio = parseFloat(ratioField.input.value);
        block.ratio = Number.isFinite(ratio) && ratio > 0 ? ratio : 16/9;
        closeOverlay();
        renderBlocks();
        scheduleAutoSave();
      };
    }

    function createField(labelText, type, value){
      const wrapper = document.createElement('div');
      const label = document.createElement('label');
      label.textContent = labelText;
      const input = document.createElement('input');
      input.type = type;
      input.value = value ?? '';
      wrapper.append(label, input);
      return { wrapper, input };
    }

    function createTextarea(labelText, value){
      const wrapper = document.createElement('div');
      const label = document.createElement('label');
      label.textContent = labelText;
      const textarea = document.createElement('textarea');
      textarea.value = value ?? '';
      wrapper.append(label, textarea);
      return { wrapper, input: textarea };
    }

    function createSelect(labelText, options, value){
      const wrapper = document.createElement('div');
      const label = document.createElement('label');
      label.textContent = labelText;
      const select = document.createElement('select');
      for(const option of options){
        const opt = document.createElement('option');
        opt.value = option.value;
        opt.textContent = option.label;
        if(option.value === value) opt.selected = true;
        select.appendChild(opt);
      }
      wrapper.append(label, select);
      return { wrapper, input: select };
    }

    function closePalette(){
      palette.hidden = true;
      paletteSearch.value = '';
      paletteResults.innerHTML = '';
      paletteActiveIndex = -1;
      document.body.style.overflow = '';
    }

    function openPalette(){
      palette.hidden = false;
      document.body.style.overflow = 'hidden';
      updatePaletteResults('');
      requestAnimationFrame(()=>{
        paletteSearch.focus();
      });
    }

    function updatePaletteResults(query){
      const normalized = query.trim().toLowerCase();
      const filtered = commands.filter((command)=>
        !normalized || command.label.toLowerCase().includes(normalized)
      );
      paletteResults.innerHTML = '';
      filtered.forEach((command, index)=>{
        const button = document.createElement('button');
        button.type = 'button';
        button.textContent = command.label;
        button.dataset.index = index;
        button.addEventListener('click', ()=>{
          command.run();
          closePalette();
        });
        paletteResults.appendChild(button);
      });
      paletteActiveIndex = filtered.length ? 0 : -1;
      highlightPaletteOption();
    }

    function highlightPaletteOption(){
      const buttons = paletteResults.querySelectorAll('button');
      buttons.forEach((button, index)=>{
        if(index === paletteActiveIndex){
          button.classList.add('active');
          button.scrollIntoView({ block:'nearest' });
        } else {
          button.classList.remove('active');
        }
      });
    }

    paletteSearch.addEventListener('input', ()=>{
      updatePaletteResults(paletteSearch.value);
    });

    palette.addEventListener('keydown', (event)=>{
      const buttons = paletteResults.querySelectorAll('button');
      if(!buttons.length) return;
      if(event.key === 'ArrowDown'){
        event.preventDefault();
        paletteActiveIndex = Math.min(buttons.length - 1, paletteActiveIndex + 1);
        highlightPaletteOption();
      } else if(event.key === 'ArrowUp'){
        event.preventDefault();
        paletteActiveIndex = Math.max(0, paletteActiveIndex - 1);
        highlightPaletteOption();
      } else if(event.key === 'Enter'){
        event.preventDefault();
        buttons[paletteActiveIndex]?.click();
      } else if(event.key === 'Escape'){
        event.preventDefault();
        closePalette();
      }
    });

    palette.addEventListener('click', (event)=>{
      if(event.target === palette){
        closePalette();
      }
    });

    function setupCommands(){
      commands.length = 0;
      commands.push(
        { label:'Añadir bloque de texto', run:()=>insertBlock(createTextBlock(), state.blocks.length) },
        { label:'Añadir bloque de imagen', run:()=>insertBlock(createImageBlock(), state.blocks.length) },
        { label:'Guardar', run:manualSave },
        { label:'Cargar', run:triggerLoad },
        { label:'Exportar JSON', run:exportState },
        { label:'Imprimir', run:()=>window.print() },
        { label:'Barajar bloques', run:shuffleBlocks },
      );
      for(const pack of themePacks){
        commands.push({
          label:`Tema: ${pack.name}`,
          run:()=>{
            applyTheme(pack);
            scheduleAutoSave();
          },
        });
      }
    }

    function shuffleBlocks(){
      if(!confirm('¿Quieres barajar los bloques?')) return;
      for(let i = state.blocks.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [state.blocks[i], state.blocks[j]] = [state.blocks[j], state.blocks[i]];
      }
      renderBlocks();
      scheduleAutoSave();
    }

    function manualSave(){
      suppressAutoSave = true;
      saveToLocal();
      suppressAutoSave = false;
      showToast('Infografía guardada en el navegador');
    }

    function triggerLoad(){
      loadInput.click();
    }

    function exportState(){
      const data = JSON.stringify({
        title: state.title,
        subtitle: state.subtitle,
        footerL: state.footerL,
        footerR: state.footerR,
        themeId: state.themeId,
        blocks: state.blocks,
      }, null, 2);
      const blob = new Blob([data], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'infografia.json';
      link.click();
      URL.revokeObjectURL(url);
    }

    loadInput.addEventListener('change', ()=>{
      const file = loadInput.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          loadState(data);
          showToast('Infografía cargada');
        } catch (error){
          console.error(error);
          showToast('No se pudo cargar el archivo');
        }
      };
      reader.readAsText(file);
    });

    function initEditable(element, key){
      element.addEventListener('input', ()=>{
        state[key] = element.textContent.trim();
        scheduleAutoSave();
      });
    }

    initEditable(titleEl, 'title');
    initEditable(subtitleEl, 'subtitle');
    initEditable(footerLEl, 'footerL');
    initEditable(footerREl, 'footerR');

    document.getElementById('fabAdd').addEventListener('click', ()=>{
      openAddMenu(document.getElementById('fabAdd'), state.blocks.length);
    });

    document.getElementById('saveButton').addEventListener('click', manualSave);
    document.getElementById('loadButton').addEventListener('click', triggerLoad);
    document.getElementById('printButton').addEventListener('click', ()=>window.print());
    document.getElementById('shuffleButton').addEventListener('click', shuffleBlocks);
    document.getElementById('paletteButton').addEventListener('click', openPalette);

    document.addEventListener('keydown', (event)=>{
      const isMac = navigator.platform.toUpperCase().includes('MAC');
      const ctrlLike = isMac ? event.metaKey : event.ctrlKey;
      if(ctrlLike && event.key.toLowerCase() === 's'){
        event.preventDefault();
        manualSave();
      } else if(ctrlLike && event.key.toLowerCase() === 'o'){
        event.preventDefault();
        triggerLoad();
      } else if(ctrlLike && event.key.toLowerCase() === 'p'){
        event.preventDefault();
        window.print();
      } else if(ctrlLike && event.key.toLowerCase() === 'k'){
        event.preventDefault();
        if(palette.hidden){
          openPalette();
        } else {
          closePalette();
        }
      } else if(!ctrlLike && !event.altKey && event.key.toLowerCase() === 'r'){
        event.preventDefault();
        shuffleBlocks();
      }
    });

    window.addEventListener('beforeunload', ()=>{
      saveToLocal();
    });

    function hydrateFromStorage(){
      const stored = localStorage.getItem(STORAGE_KEY);
      if(stored){
        try{
          const data = JSON.parse(stored);
          loadState(data);
          return;
        } catch(error){
          console.error(error);
        }
      }
      applyTheme(themePacks.find((pack)=>pack.id === defaultThemeId) || themePacks[0]);
      state.blocks = createDefaultBlocks();
      suppressAutoSave = true;
      applyStateToDom();
      suppressAutoSave = false;
    }

    hydrateFromStorage();
    setupCommands();
    renderBlocks();
  </script>
</body>
</html>
