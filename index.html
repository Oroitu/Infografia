<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantilla dinámica de infografías</title>
  <style>
    :root{
      --color-background:#0e3a5a;
      --color-background-elevated:rgba(14,58,90,0.9);
      --color-on-background:#ffffff;
      --color-surface:#0f2840;
      --color-on-surface:#e9f4ff;
      --color-surface-border:rgba(255,255,255,0.12);
      --color-paper:#ffffff;
      --color-paper-muted:#f6fbff;
      --color-paper-border:rgba(14,34,51,0.12);
      --color-text-primary:#0b1f2c;
      --color-text-secondary:#6b7b88;
      --color-accent:#2e69a1;
      --color-on-accent:#ffffff;
      --color-accent-strong:#0c3250;
      --color-on-accent-strong:#ffffff;
      --font-heading:'Poppins','Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      --font-body:ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans','Liberation Sans','Apple Color Emoji','Segoe UI Emoji';
      --font-weight-heading:700;
      --font-weight-body:400;
      --spacing-xs:4px;
      --spacing-sm:8px;
      --spacing-md:12px;
      --spacing-lg:18px;
      --spacing-xl:26px;
      --spacing-2xl:36px;
      --spacing-density:standard;
      --radius-none:0px;
      --radius-sm:8px;
      --radius-md:14px;
      --radius-lg:18px;
      --shadow-sm:0 1px 2px rgba(0,0,0,0.12);
      --shadow-md:0 10px 30px rgba(0,0,0,0.18);
      --shadow-lg:0 18px 50px rgba(0,0,0,0.25);
      --control-background:rgba(255,255,255,0.06);
      --control-border:rgba(255,255,255,0.15);
      --control-text:var(--color-on-surface);
      --size-row-unit:2px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font-body);
      font-weight:var(--font-weight-body);
      background:linear-gradient(160deg,var(--color-background) 0 35%, var(--color-accent) 35% 36%, var(--color-surface) 36%);
      color:var(--color-text-primary);
    }

    header.appbar{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(1.1) blur(6px);
      background:var(--color-background-elevated); color:var(--color-on-background); padding:var(--spacing-sm) var(--spacing-xl); display:flex; align-items:center; gap:var(--spacing-md);
      border-bottom:2px solid var(--color-surface-border);
    }
    header.appbar h1{font-size:18px; font-weight:var(--font-weight-heading); margin:0}
    header.appbar .spacer{flex:1}
    header.appbar a.btn{color:var(--color-on-background); text-decoration:none; background:color-mix(in srgb, var(--color-on-background) 16%, transparent); padding:var(--spacing-xs) var(--spacing-sm); border-radius:var(--radius-sm); font-weight:600}

    .shell{display:grid; grid-template-columns:360px 1fr; gap:var(--spacing-lg); width:min(1400px, 100%); margin:var(--spacing-lg) auto; padding:0 var(--spacing-md)}

    /* Panel izquierdo ("backend" en el navegador) */
    .panel{
      background:var(--color-surface); color:var(--color-on-surface); border-radius:var(--radius-lg); box-shadow:var(--shadow-md);
      overflow:hidden; display:flex; flex-direction:column; min-height:72vh
    }
    .panel header{padding:var(--spacing-md) var(--spacing-xl); background:color-mix(in srgb, var(--color-on-surface) 8%, transparent); border-bottom:1px solid var(--color-surface-border)}
    .panel header h2{margin:0; font-size:16px; font-family:var(--font-heading); font-weight:var(--font-weight-heading)}
    .panel .content{padding:var(--spacing-lg); overflow:auto; display:flex; flex-direction:column; gap:var(--spacing-md)}

    .panel fieldset{border:1px solid var(--color-surface-border); border-radius:var(--radius-md); padding:var(--spacing-md); margin:0; display:flex; flex-direction:column; gap:var(--spacing-sm)}
    .panel legend{padding:0 var(--spacing-xs); color:color-mix(in srgb, var(--color-on-surface) 80%, transparent); font-weight:var(--font-weight-heading)}
    label{display:block; font-size:13px; margin:var(--spacing-sm) 0 var(--spacing-xs); color:color-mix(in srgb, var(--color-on-surface) 88%, transparent)}
    input[type="text"], textarea, input[type="number"], select{
      width:100%; padding:var(--spacing-sm) var(--spacing-md); border-radius:var(--radius-sm); border:1px solid var(--control-border); background:var(--control-background); color:var(--control-text); outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    input[type="file"]{width:100%; color:var(--control-text)}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:var(--spacing-sm)}

    .btn{display:inline-flex; align-items:center; justify-content:center; gap:var(--spacing-xs); padding:var(--spacing-sm) var(--spacing-md); border-radius:var(--radius-md); border:1px solid var(--color-paper-border); cursor:pointer; font-weight:700; text-decoration:none; transition:transform 120ms ease, box-shadow 120ms ease}
    .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow-sm)}
    .btn.primary{background:var(--color-paper); color:var(--color-text-primary)}
    .btn.secondary{background:var(--control-background); color:var(--control-text); border-color:var(--control-border)}
    .btn.block{width:100%}
    .btnbar{display:flex; gap:var(--spacing-sm); flex-wrap:wrap}

    .hint{font-size:12px; color:color-mix(in srgb, var(--color-on-surface) 70%, transparent)}

    .contrast-report{font-size:12px; border-radius:var(--radius-sm); padding:var(--spacing-sm); background:color-mix(in srgb, var(--color-on-surface) 12%, transparent); color:var(--color-on-surface); border:1px solid color-mix(in srgb, var(--color-on-surface) 16%, transparent)}
    .contrast-report[data-status="fail"]{background:color-mix(in srgb, #f97316 14%, transparent); color:color-mix(in srgb, #f97316 80%, black)}
    .contrast-report[data-status="aa"]{background:color-mix(in srgb, #0ea5e9 12%, transparent); color:color-mix(in srgb, #0ea5e9 80%, black)}
    .contrast-report[data-status="aaa"]{background:color-mix(in srgb, #22c55e 12%, transparent); color:color-mix(in srgb, #14532d 90%, white)}

    /* Área derecha: vista previa de la infografía */
    .stage-wrap{position:relative}
    .stage-tools{position:absolute; top:var(--spacing-xs); right:var(--spacing-xs); display:flex; gap:var(--spacing-xs); z-index:20}
    .stage-tools .btn{background:var(--color-surface); color:var(--color-on-surface); border-color:var(--color-surface-border)}

    .infographic{
      --cols:3;
      background:var(--color-paper); color:var(--color-text-primary); border-radius:var(--radius-lg); box-shadow:var(--shadow-lg);
      padding:var(--spacing-xl); min-height:1000px; position:relative;
    }
    /* Encabezado fijo */
    .ig-header{padding:var(--spacing-xs) 0 var(--spacing-md); border-bottom:4px solid var(--color-accent); margin-bottom:var(--spacing-md)}
    .ig-header h1{margin:0; font-size:40px; font-family:var(--font-heading); font-weight:var(--font-weight-heading); color:var(--color-accent)}
    .ig-header h2{margin:var(--spacing-xs) 0 0; font-weight:500; color:var(--color-text-secondary); font-family:var(--font-body)}

    /* Grid de bloques */
    .ig-grid{
      display:grid; grid-template-columns: repeat(var(--cols), 1fr);
      column-gap:var(--spacing-lg); row-gap:0; grid-auto-rows: var(--size-row-unit);
      grid-auto-flow:dense;
    }

    .block{border-radius:var(--radius-md); overflow:hidden; border:1px solid var(--color-paper-border); background:var(--color-paper-muted); align-self:start; margin-bottom:var(--spacing-lg)}
    .block.fill-ink{background:var(--color-accent-strong); color:var(--color-on-accent-strong)}
    .block .pad{padding:var(--spacing-md)}
    .block h3{margin:0 0 var(--spacing-xs); font-size:20px; font-family:var(--font-heading); font-weight:var(--font-weight-heading)}
    .block p{margin:0; font-family:var(--font-body); line-height:1.5}

    .imgbox{display:block; width:100%; overflow:hidden}
    .imgbox img{display:block; width:100%; height:100%; object-fit:cover}

    .ig-footer{margin-top:var(--spacing-lg); padding-top:var(--spacing-sm); border-top:2px solid var(--color-paper-border); display:flex; justify-content:space-between; align-items:center; color:var(--color-text-secondary); font-size:14px}

    /* Print/PDF */
    @media print{
      body{background:#fff}
      header.appbar, .panel, .stage-tools{display:none !important}
      .shell{grid-template-columns:1fr; margin:0; padding:0}
      @page{ size: A4 portrait; margin: 10mm }
      .infographic{box-shadow:none; border-radius:0; padding:10mm; min-height:auto}
      .ig-header h1{font-size:28pt}
    }

    /* Responsivo */
    @media (max-width: 1100px){
      .shell{grid-template-columns:1fr}
      .stage-tools{position:static; margin:var(--spacing-sm) 0}
    }
  </style>
</head>
<body>
  <header class="appbar">
    <h1>Plantilla dinámica de infografías</h1>
    <span class="spacer"></span>
    <a class="btn" href="#" onclick="window.print()">Exportar a PDF</a>
  </header>

  <main class="shell">
    <!-- PANEL IZQUIERDO ("backend" en el navegador) -->
    <section class="panel" id="panel">
      <header><h2>1) Configura tu infografía</h2></header>
      <div class="content">
        <fieldset>
          <legend>Paquetes de tema</legend>
          <label for="themePack">Selecciona un tema</label>
          <select id="themePack" aria-describedby="contrastReport"></select>
          <div id="contrastReport" class="contrast-report" role="status" aria-live="polite">Cargando temas…</div>
        </fieldset>

        <fieldset>
          <legend>Cabecera y pie</legend>
          <label for="title">Título</label>
          <input id="title" type="text" placeholder="Título principal" value="Título de ejemplo"/>
          <label for="subtitle">Subtítulo</label>
          <input id="subtitle" type="text" placeholder="Subtítulo" value="Un subtítulo descriptivo"/>
          <label for="footerL">Footer (izquierda)</label>
          <input id="footerL" type="text" placeholder="Autor / Fuente" value="Autor / Fuente"/>
          <label for="footerR">Footer (derecha)</label>
          <input id="footerR" type="text" placeholder="Logo / Fecha" value="Oct 2025"/>
        </fieldset>

        <fieldset>
          <legend>Bloques e imágenes</legend>
          <div class="row">
            <div>
              <label for="numText">Bloques de texto a añadir</label>
              <input id="numText" type="number" min="0" max="20" value="3" />
            </div>
            <div>
              <label for="numImg">Bloques de imagen a añadir</label>
              <input id="numImg" type="number" min="0" max="20" value="2" />
            </div>
          </div>
          <p class="hint">Máximo de 3 columnas. Los textos tienen altura ≤ 3×su anchura. Los bloques de imagen respetan su ratio ancho/alto. Los formularios existentes se mantienen, puedes sumar más con estos campos.</p>
          <div class="btnbar">
            <button class="btn primary" id="buildForms">Crear formularios</button>
            <button class="btn secondary" id="clearForms" type="button">Limpiar</button>
          </div>
        </fieldset>

        <form id="blocksForm"></form>

        <div class="btnbar">
          <button class="btn primary block" id="generate">2) Generar infografía</button>
        </div>
        <div class="btnbar">
          <button class="btn secondary block" type="button" id="saveInfographic">Guardar infografía</button>
          <button class="btn secondary block" type="button" id="loadInfographic">Cargar infografía</button>
          <input type="file" id="loadInfographicFile" accept="application/json" hidden />
        </div>
      </div>
    </section>

    <!-- PREVISUALIZACIÓN (frontend) -->
    <section class="stage-wrap">
      <div class="stage-tools">
        <button class="btn" id="shuffle">Barajar distribución</button>
        <button class="btn" onclick="window.print()">Exportar a PDF</button>
      </div>
      <article class="infographic" id="infographic">
        <header class="ig-header">
          <h1 id="ig-title">Título de ejemplo</h1>
          <h2 id="ig-subtitle">Un subtítulo descriptivo</h2>
        </header>
        <section class="ig-grid" id="ig-grid" aria-live="polite"></section>
        <footer class="ig-footer">
          <span id="ig-footerL">Autor / Fuente</span>
          <span id="ig-footerR">Oct 2025</span>
        </footer>
      </article>
    </section>
  </main>

  <script type="module">
    import { themePacks, defaultThemeId } from './theme-packs.js';

    // Estado de la app
    const state = {
      blocks: [], // {type:'text'|'img', text?, file?, ratio?, id}
      seed: Math.random() * 1e9 | 0,
      themeId: defaultThemeId,
    };

    const root = document.documentElement;
    const themeSelect = document.getElementById('themePack');
    const contrastReport = document.getElementById('contrastReport');

    function hexToRgb(color){
      if(typeof color !== 'string') return null;
      const hex = color.trim().replace('#', '');
      const normalized = hex.length === 3 ? hex.split('').map((c)=>c + c).join('') : hex;
      if(normalized.length !== 6) return null;
      const num = parseInt(normalized, 16);
      if(Number.isNaN(num)) return null;
      return {
        r: (num >> 16) & 255,
        g: (num >> 8) & 255,
        b: num & 255,
      };
    }

    function relativeLuminance(color){
      const rgb = typeof color === 'string' ? hexToRgb(color) : color;
      if(!rgb) return 0;
      const transform = (value)=>{
        const channel = value / 255;
        return channel <= 0.03928 ? channel / 12.92 : Math.pow((channel + 0.055) / 1.055, 2.4);
      };
      const r = transform(rgb.r);
      const g = transform(rgb.g);
      const b = transform(rgb.b);
      return 0.2126 * r + 0.7152 * g + 0.0722 * b;
    }

    function contrastRatio(colorA, colorB){
      const lumA = relativeLuminance(colorA);
      const lumB = relativeLuminance(colorB);
      const brightest = Math.max(lumA, lumB);
      const darkest = Math.min(lumA, lumB);
      return (brightest + 0.05) / (darkest + 0.05);
    }

    function toRgba(color, alpha){
      const rgb = hexToRgb(color);
      if(!rgb) return color;
      const a = typeof alpha === 'number' ? Math.min(Math.max(alpha, 0), 1) : 1;
      return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${a})`;
    }

    function mixColors(colorA, colorB, amount = 0.5){
      const a = hexToRgb(colorA);
      const b = hexToRgb(colorB);
      if(!a || !b) return colorA;
      const ratio = Math.min(Math.max(amount, 0), 1);
      const r = Math.round(a.r + (b.r - a.r) * ratio);
      const g = Math.round(a.g + (b.g - a.g) * ratio);
      const bch = Math.round(a.b + (b.b - a.b) * ratio);
      return `#${[r, g, bch].map((v)=>v.toString(16).padStart(2, '0')).join('')}`;
    }

    function chooseReadableText(background, ...candidates){
      let best = candidates[0] || '#000000';
      let bestRatio = 0;
      for(const candidate of candidates){
        if(!candidate) continue;
        const ratio = contrastRatio(candidate, background);
        if(ratio > bestRatio){
          best = candidate;
          bestRatio = ratio;
        }
      }
      return best;
    }

    function applySpacing(spacing){
      const tokens = ['--spacing-xs','--spacing-sm','--spacing-md','--spacing-lg','--spacing-xl','--spacing-2xl','--spacing-3xl'];
      const values = Array.isArray(spacing?.scale) ? spacing.scale : [];
      tokens.forEach((token, index)=>{
        const value = values[index];
        if(typeof value === 'number'){
          root.style.setProperty(token, `${value}px`);
        } else if(typeof value === 'string'){
          root.style.setProperty(token, value);
        }
      });
      if(spacing?.density){
        root.style.setProperty('--spacing-density', spacing.density);
      }
    }

    function applyShadows(shadows){
      const list = Array.isArray(shadows) ? shadows : [];
      const fallback = list[list.length - 1] || '0 10px 30px rgba(0,0,0,0.18)';
      root.style.setProperty('--shadow-sm', list[0] || fallback);
      root.style.setProperty('--shadow-md', list[1] || fallback);
      root.style.setProperty('--shadow-lg', list[2] || fallback);
    }

    function applyTheme(theme){
      if(!theme) return;
      state.themeId = theme.id;
      const palette = theme.palette;
      root.style.setProperty('--color-background', palette.background);
      root.style.setProperty('--color-accent', palette.accent);
      root.style.setProperty('--color-accent-strong', palette.accentStrong);
      root.style.setProperty('--color-surface', palette.surface);
      root.style.setProperty('--color-paper', palette.paper);
      root.style.setProperty('--color-text-primary', palette.textPrimary);
      root.style.setProperty('--color-text-secondary', palette.textSecondary);

      const surfaceText = chooseReadableText(palette.surface, palette.textPrimary, palette.paper, '#ffffff');
      const backgroundText = chooseReadableText(palette.background, palette.paper, palette.textPrimary, '#ffffff');
      const accentText = chooseReadableText(palette.accent, palette.paper, palette.textPrimary, '#ffffff');
      const accentStrongText = chooseReadableText(palette.accentStrong, palette.paper, palette.textPrimary, '#ffffff');

      root.style.setProperty('--color-on-surface', surfaceText);
      root.style.setProperty('--color-on-background', backgroundText);
      root.style.setProperty('--color-on-accent', accentText);
      root.style.setProperty('--color-on-accent-strong', accentStrongText);

      const surfaceLum = relativeLuminance(palette.surface);
      const paperLum = relativeLuminance(palette.paper);
      const surfaceBorder = surfaceLum < 0.5 ? 'rgba(255,255,255,0.18)' : 'rgba(0,0,0,0.15)';
      const paperBorder = paperLum > 0.6 ? 'rgba(0,0,0,0.12)' : 'rgba(255,255,255,0.16)';
      const controlBackground = surfaceLum < 0.5 ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.05)';
      const controlBorder = surfaceLum < 0.5 ? 'rgba(255,255,255,0.18)' : 'rgba(0,0,0,0.12)';

      root.style.setProperty('--color-surface-border', surfaceBorder);
      root.style.setProperty('--color-paper-border', paperBorder);
      root.style.setProperty('--control-background', controlBackground);
      root.style.setProperty('--control-border', controlBorder);
      root.style.setProperty('--control-text', surfaceText);
      root.style.setProperty('--color-background-elevated', toRgba(palette.background, 0.9));

      const mutedPaper = mixColors(palette.paper, palette.accent, 0.08);
      root.style.setProperty('--color-paper-muted', mutedPaper);

      if(theme.typography){
        if(theme.typography.heading) root.style.setProperty('--font-heading', theme.typography.heading);
        if(theme.typography.body) root.style.setProperty('--font-body', theme.typography.body);
        if(Number.isFinite(theme.typography.weightHeading)) root.style.setProperty('--font-weight-heading', `${theme.typography.weightHeading}`);
        if(Number.isFinite(theme.typography.weightBody)) root.style.setProperty('--font-weight-body', `${theme.typography.weightBody}`);
      }

      if(theme.radii){
        if(theme.radii.none) root.style.setProperty('--radius-none', theme.radii.none);
        if(theme.radii.sm) root.style.setProperty('--radius-sm', theme.radii.sm);
        if(theme.radii.md) root.style.setProperty('--radius-md', theme.radii.md);
        if(theme.radii.lg) root.style.setProperty('--radius-lg', theme.radii.lg);
      }

      applySpacing(theme.spacing);
      applyShadows(theme.shadows);

      if(themeSelect && themeSelect.value !== theme.id){
        themeSelect.value = theme.id;
      }

      updateContrastReport(theme);
    }

    function updateContrastReport(theme){
      if(!contrastReport || !theme) return;
      const ratio = contrastRatio(theme.palette.textPrimary, theme.palette.background);
      const formatted = ratio.toFixed(2);
      let status = 'fail';
      let message = `Contraste fondo/texto: ${formatted}:1 — No alcanza AA (4.5:1).`;
      if(ratio >= 7){
        status = 'aaa';
        message = `Contraste fondo/texto: ${formatted}:1 — Cumple AAA.`;
      } else if(ratio >= 4.5){
        status = 'aa';
        message = `Contraste fondo/texto: ${formatted}:1 — Cumple AA, no AAA (7:1).`;
      }
      contrastReport.dataset.status = status;
      contrastReport.textContent = message;
    }

    function populateThemeOptions(){
      if(!themeSelect) return;
      themeSelect.innerHTML = '';
      for(const theme of themePacks){
        const option = document.createElement('option');
        option.value = theme.id;
        option.textContent = theme.name;
        themeSelect.appendChild(option);
      }
      const fallback = themePacks.find((theme)=>theme.id === defaultThemeId) || themePacks[0];
      if(fallback){
        themeSelect.value = fallback.id;
        applyTheme(fallback);
      }
    }

    if(themeSelect){
      themeSelect.addEventListener('change', (event)=>{
        const themeId = event.target.value;
        const theme = themePacks.find((item)=>item.id === themeId);
        if(theme){
          applyTheme(theme);
        }
      });
    }

    populateThemeOptions();

    // Utilidad: pseudo-aleatorio con semilla (para poder "barajar" de forma reproducible)
    function mulberry32(a){
      return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t>>>15, t | 1); t ^= t + Math.imul(t ^ t>>>7, t | 61); return ((t ^ t>>>14) >>> 0) / 4294967296; }
    }

    // Construye formularios para texto/imagen
    const blocksForm = document.getElementById('blocksForm');
    const numTextInput = document.getElementById('numText');
    const numImgInput = document.getElementById('numImg');

    function currentTextCount(){
      return state.blocks.filter((b)=>b.type === 'text').length;
    }

    function currentImageCount(){
      return state.blocks.filter((b)=>b.type === 'img').length;
    }

    function setupImageRatioAuto(fs, id){
      const fileField = fs.querySelector(`input[name="file-${id}"]`);
      if(!fileField) return;
      fileField.addEventListener('change', (ev)=>{
        const file = ev.target.files?.[0];
        if(!file){
          fs.dataset.fileName = '';
          return;
        }
        fs.dataset.fileName = file.name || '';
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = ()=>{
          const rw = fs.querySelector(`input[name="rw-${id}"]`);
          const rh = fs.querySelector(`input[name="rh-${id}"]`);
          if(rw) rw.value = String(img.naturalWidth || 16);
          if(rh) rh.value = String(img.naturalHeight || 9);
          URL.revokeObjectURL(url);
        };
        img.onerror = ()=> URL.revokeObjectURL(url);
        img.src = url;
      });
    }

    function createTextBlock(initial = {}){
      const id = crypto.randomUUID();
      const index = currentTextCount() + 1;
      const fs = document.createElement('fieldset');
      fs.dataset.blockId = id;
      fs.dataset.blockType = 'text';
      fs.innerHTML = `
        <legend>Bloque de texto #${index}</legend>
        <label>Título opcional</label>
        <input type="text" name="title-${id}" placeholder="Encabezado del bloque" />
        <label>Contenido</label>
        <textarea name="text-${id}" placeholder="Escribe el contenido del bloque..."></textarea>
        <div class="row">
          <div>
            <label>Estilo</label>
            <select name="style-${id}">
              <option value="light">Claro</option>
              <option value="dark">Oscuro</option>
            </select>
          </div>
          <div>
            <label>Importancia</label>
            <select name="importance-${id}">
              <option value="auto">Auto</option>
              <option value="destacado">Destacado</option>
            </select>
          </div>
        </div>
      `;

      blocksForm.appendChild(fs);
      state.blocks.push({ id, type:'text' });

      const titleField = fs.querySelector(`input[name="title-${id}"]`);
      const textField = fs.querySelector(`textarea[name="text-${id}"]`);
      const styleField = fs.querySelector(`select[name="style-${id}"]`);
      const importanceField = fs.querySelector(`select[name="importance-${id}"]`);

      if(titleField) titleField.value = initial.title ?? `Bloque ${index}`;
      if(textField) textField.value = initial.text ?? 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec commodo.';
      if(styleField){
        const style = (initial.style === 'dark') ? 'dark' : 'light';
        styleField.value = style;
      }
      if(importanceField){
        const importance = initial.importance === 'destacado' ? 'destacado' : 'auto';
        importanceField.value = importance;
      }
    }

    function createImageBlock(initial = {}){
      const id = crypto.randomUUID();
      const index = currentImageCount() + 1;
      const fs = document.createElement('fieldset');
      fs.dataset.blockId = id;
      fs.dataset.blockType = 'img';
      fs.innerHTML = `
        <legend>Imagen #${index}</legend>
        <label>Archivo</label>
        <input type="file" accept="image/*" name="file-${id}" />
        <label>URL o ruta de la imagen</label>
        <input type="text" placeholder="https://ejemplo.com/imagen.jpg" name="url-${id}" />
        <div class="row">
          <div>
            <label>Ratio ancho</label>
            <input type="number" step="0.01" min="0.1" value="16" name="rw-${id}" />
          </div>
          <div>
            <label>Ratio alto</label>
            <input type="number" step="0.01" min="0.1" value="9" name="rh-${id}" />
          </div>
        </div>
        <p class="hint">La plantilla usará este ratio para fijar la altura del bloque según el ancho ocupado.</p>
      `;

      blocksForm.appendChild(fs);
      state.blocks.push({ id, type:'img' });

      fs.dataset.fileName = initial.name || '';

      const urlField = fs.querySelector(`input[name="url-${id}"]`);
      const rwField = fs.querySelector(`input[name="rw-${id}"]`);
      const rhField = fs.querySelector(`input[name="rh-${id}"]`);

      const ratioW = Number(initial.ratioW ?? initial.ratio ?? initial.width);
      const ratioH = Number(initial.ratioH ?? initial.height);

      if(urlField) urlField.value = initial.url || initial.src || '';
      if(rwField) rwField.value = Number.isFinite(ratioW) && ratioW > 0 ? String(ratioW) : '16';
      if(rhField) rhField.value = Number.isFinite(ratioH) && ratioH > 0 ? String(ratioH) : '9';

      setupImageRatioAuto(fs, id);
    }

    function addTextBlocks(count, data = []){
      for(let i=0;i<count;i++){
        createTextBlock(data[i] || {});
      }
    }

    function addImageBlocks(count, data = []){
      for(let i=0;i<count;i++){
        createImageBlock(data[i] || {});
      }
    }

    function resetForms(){
      blocksForm.innerHTML = '';
      state.blocks = [];
    }

    document.getElementById('buildForms').addEventListener('click', (e)=>{
      e.preventDefault();
      const nText = Math.max(0, Math.floor(Number(numTextInput.value) || 0));
      const nImg = Math.max(0, Math.floor(Number(numImgInput.value) || 0));
      if(nText) addTextBlocks(nText);
      if(nImg) addImageBlocks(nImg);
      numTextInput.value = '0';
      numImgInput.value = '0';
    });

    document.getElementById('clearForms').addEventListener('click', (e)=>{
      e.preventDefault();
      resetForms();
      numTextInput.value = '0';
      numImgInput.value = '0';
    });

    function collectFormData(){
      const title = document.getElementById('title').value.trim();
      const subtitle = document.getElementById('subtitle').value.trim();
      const footerL = document.getElementById('footerL').value.trim();
      const footerR = document.getElementById('footerR').value.trim();

      const blocks = [];
      for(const b of state.blocks){
        if(b.type==='text'){
          const titleField = blocksForm.querySelector(`input[name="title-${b.id}"]`);
          const textField = blocksForm.querySelector(`textarea[name="text-${b.id}"]`);
          const styleField = blocksForm.querySelector(`select[name="style-${b.id}"]`);
          const importanceField = blocksForm.querySelector(`select[name="importance-${b.id}"]`);
          const text = textField?.value.trim();
          if(text){
            blocks.push({
              type:'text',
              title: titleField?.value.trim() || '',
              text,
              style: styleField?.value || 'light',
              importance: importanceField?.value || 'auto',
            });
          }
        } else if(b.type==='img'){
          const fileInput = blocksForm.querySelector(`input[name="file-${b.id}"]`);
          const urlInput = blocksForm.querySelector(`input[name="url-${b.id}"]`);
          const rwInput = blocksForm.querySelector(`input[name="rw-${b.id}"]`);
          const rhInput = blocksForm.querySelector(`input[name="rh-${b.id}"]`);
          const fieldset = blocksForm.querySelector(`fieldset[data-block-id="${b.id}"]`);
          const file = fileInput?.files?.[0] || null;
          const url = urlInput?.value.trim() || '';
          const ratioW = parseFloat(rwInput?.value || '1') || 1;
          const ratioH = parseFloat(rhInput?.value || '1') || 1;
          if(file || url){
            const block = { type:'img', ratioW, ratioH };
            if(file){
              block.file = file;
              if(file.name) block.name = file.name;
            }
            if(url) block.url = url;
            if(!file && fieldset?.dataset.fileName){
              block.name = fieldset.dataset.fileName;
            }
            blocks.push(block);
          }
        }
      }

      return { title, subtitle, footerL, footerR, blocks };
    }

    function applyMetadataToPreview(meta){
      document.getElementById('ig-title').textContent = meta.title || '—';
      document.getElementById('ig-subtitle').textContent = meta.subtitle || '';
      document.getElementById('ig-footerL').textContent = meta.footerL || '';
      document.getElementById('ig-footerR').textContent = meta.footerR || '';
    }

    function readFileAsDataURL(file){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result);
        reader.onerror = ()=> reject(reader.error || new Error('No se pudo leer el archivo.'));
        reader.readAsDataURL(file);
      });
    }

    async function sanitizeBlocksForSaving(blocks){
      const plain = [];
      let droppedImages = 0;
      for(const block of blocks){
        if(block.type === 'text'){
          plain.push({
            type:'text',
            title:block.title || '',
            text:block.text || '',
            style:block.style || 'light',
            importance:block.importance || 'auto',
          });
        } else if(block.type === 'img'){
          const ratioW = block.ratioW || 1;
          const ratioH = block.ratioH || 1;
          const base = { type:'img', ratioW, ratioH };
          const url = (block.url || '').trim();
          if(url){
            const entry = { ...base, url };
            if(block.name) entry.name = block.name;
            plain.push(entry);
          } else if(block.file && typeof File !== 'undefined' && block.file instanceof File){
            try{
              const dataUrl = await readFileAsDataURL(block.file);
              if(typeof dataUrl === 'string' && dataUrl){
                const entry = { ...base, url: dataUrl };
                const name = block.name || block.file.name;
                if(name) entry.name = name;
                plain.push(entry);
              } else {
                droppedImages++;
              }
            } catch(err){
              droppedImages++;
            }
          } else {
            droppedImages++;
          }
        }
      }
      return { plain, droppedImages };
    }

    function loadInfographicFromData(data){
      if(!data || typeof data !== 'object') throw new Error('Datos inválidos');
      const blocks = Array.isArray(data.blocks) ? data.blocks : [];
      const textBlocks = blocks.filter((b)=>b?.type==='text');
      const imgBlocks = blocks.filter((b)=>b?.type==='img');

      document.getElementById('title').value = data.title || '';
      document.getElementById('subtitle').value = data.subtitle || '';
      document.getElementById('footerL').value = data.footerL || '';
      document.getElementById('footerR').value = data.footerR || '';

      resetForms();
      addTextBlocks(textBlocks.length, textBlocks);
      addImageBlocks(imgBlocks.length, imgBlocks);
      numTextInput.value = '0';
      numImgInput.value = '0';

      const meta = collectFormData();
      state.data = meta.blocks;
      applyMetadataToPreview(meta);
      state.seed = Math.random()*1e9|0;
      renderInfographic();
    }

    // Generar
    document.getElementById('generate').addEventListener('click', (e)=>{
      e.preventDefault();
      const meta = collectFormData();
      applyMetadataToPreview(meta);
      state.data = meta.blocks;
      state.seed = Math.random()*1e9|0;
      renderInfographic();
    });

    document.getElementById('saveInfographic').addEventListener('click', async ()=>{
      try{
        const meta = collectFormData();
        const { plain, droppedImages } = await sanitizeBlocksForSaving(meta.blocks);
        const payload = {
          version: 1,
          title: meta.title,
          subtitle: meta.subtitle,
          footerL: meta.footerL,
          footerR: meta.footerR,
          blocks: plain,
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const baseName = (meta.title || 'infografia')
          .replace(/[^a-z0-9_-]+/gi, '_')
          .replace(/_+/g, '_')
          .replace(/^_|_$/g, '') || 'infografia';
        link.download = `${baseName}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        if(droppedImages){
          alert(`Se omitieron ${droppedImages} imagen(es) sin fuente disponible en el archivo guardado.`);
        }
      } catch(err){
        console.error(err);
        alert('No se pudo guardar la infografía.');
      }
    });

    const loadInput = document.getElementById('loadInfographicFile');
    document.getElementById('loadInfographic').addEventListener('click', ()=> loadInput.click());
    loadInput.addEventListener('change', (event)=>{
      const file = event.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result || '{}');
          loadInfographicFromData(data);
        } catch(err){
          console.error(err);
          alert('El archivo seleccionado no contiene una infografía válida.');
        }
      };
      reader.onerror = ()=>{
        console.error(reader.error);
        alert('No se pudo leer el archivo de infografía.');
      };
      reader.readAsText(file);
      event.target.value = '';
    });

    document.getElementById('shuffle').addEventListener('click', ()=>{
      state.seed = Math.random()*1e9|0; renderInfographic();
    });

    let resizeScheduled = false;
    window.addEventListener('resize', ()=>{
      if(resizeScheduled) return;
      resizeScheduled = true;
      requestAnimationFrame(()=>{
        resizeScheduled = false;
        if(typeof state.reflowBlocks === 'function') state.reflowBlocks();
      });
    });

    // Renderizado de la infografía
    function renderInfographic(){
      const grid = document.getElementById('ig-grid');
      grid.innerHTML = '';
      const rand = mulberry32(state.seed);

      // Copia y mezcla de bloques
      const items = (state.data||[]).map((x,i)=>({ ...x, _i:i }));
      for(let i=items.length-1;i>0;i--){ const j = Math.floor(rand()*(i+1)); [items[i],items[j]]=[items[j],items[i]]; }

      const cols = 3; // máximo 3 columnas
      const container = document.getElementById('infographic');
      container.style.setProperty('--cols', cols);

      const styles = getComputedStyle(grid);
      const columnGap = parseFloat(styles.getPropertyValue('column-gap') || styles.getPropertyValue('gap')) || 16;
      const totalW = grid.clientWidth || grid.getBoundingClientRect().width || 1;
      const baseColW = (totalW - columnGap*(cols-1)) / cols;

      const computeRowUnit = ()=> parseFloat(getComputedStyle(grid).getPropertyValue('grid-auto-rows')) || 2;
      const scheduleSizing = (block, kind)=>{
        requestAnimationFrame(()=>{
          const rowUnit = computeRowUnit();
          if(kind==='text'){
            block.style.removeProperty('maxHeight');
            block.style.overflow = 'visible';
            const width = block.getBoundingClientRect().width || baseColW;
            const maxH = width * 3;
            const natural = block.scrollHeight;
            const finalH = Math.min(natural, maxH);
            if(natural > maxH){
              block.style.maxHeight = `${maxH}px`;
              block.style.overflow = 'hidden';
            } else {
              block.style.overflow = 'visible';
            }
            const span = Math.max(1, Math.ceil(finalH / rowUnit));
            block.style.gridRowEnd = `span ${span}`;
          } else if(kind==='img'){
            const width = block.getBoundingClientRect().width || baseColW;
            const ratioW = parseFloat(block.dataset.ratiow) || 1;
            const ratioH = parseFloat(block.dataset.ratioh) || 1;
            const finalH = width * (ratioH / ratioW);
            const span = Math.max(1, Math.ceil(finalH / rowUnit));
            block.style.gridRowEnd = `span ${span}`;
          }
        });
      };

      items.forEach((item)=>{
        let colSpan = 1;
        if(item.type === 'text'){
          const textContent = (item.text||'').trim();
          const length = textContent.length;
          if(cols === 1){
            colSpan = 1;
          } else if(length < 120){
            colSpan = 1;
          } else if(length < 320){
            const choices = [2,3].filter(n=>n<=cols);
            colSpan = choices.length ? choices[(rand() < 0.6 ? 0 : choices.length-1)] : 1;
          } else {
            colSpan = Math.min(3, cols);
          }
          if((item.importance||'auto') === 'destacado'){
            colSpan = Math.min(3, cols);
            if(colSpan < 2 && cols >= 2) colSpan = 2;
          }
        } else if(item.type === 'img'){
          const choices = [1,2,3].filter(n=>n<=cols);
          const idx = Math.floor(rand()*choices.length);
          colSpan = choices[idx] || 1;
        }

        const block = document.createElement('div');
        block.className = 'block';
        block.style.gridColumn = `span ${colSpan}`;
        block.dataset.type = item.type;

        if(item.type==='text'){
          const pad = document.createElement('div'); pad.className='pad';
          if(item.title){ const h = document.createElement('h3'); h.textContent=item.title; pad.appendChild(h); }
          const p = document.createElement('p'); p.textContent = item.text; pad.appendChild(p);
          block.appendChild(pad);
          if((item.style||'light')==='dark') block.classList.add('fill-ink');

          grid.appendChild(block);
          scheduleSizing(block, 'text');
        }
        else if(item.type==='img'){
          const ratioW = (item.ratioW>0?item.ratioW:16);
          const ratioH = (item.ratioH>0?item.ratioH:9);
          block.dataset.ratiow = String(ratioW);
          block.dataset.ratioh = String(ratioH);

          const box = document.createElement('div'); box.className='imgbox';
          box.style.aspectRatio = `${ratioW} / ${ratioH}`;
          const img = new Image();
          const src = item.file ? URL.createObjectURL(item.file) : (item.url || '').trim();
          if(!src){ return; }
          img.decoding = 'async';
          img.alt = item.name || '';
          img.addEventListener('load', ()=>{
            scheduleSizing(block, 'img');
            if(item.file) URL.revokeObjectURL(src);
          });
          img.addEventListener('error', ()=>{
            if(item.file) URL.revokeObjectURL(src);
            block.classList.add('img-error');
          });
          img.src = src;
          box.appendChild(img);
          block.appendChild(box);

          grid.appendChild(block);
          scheduleSizing(block, 'img');
        }
      });

      state.reflowBlocks = ()=>{
        const blocks = grid.querySelectorAll('.block');
        blocks.forEach((block)=>{
          const type = block.dataset.type;
          scheduleSizing(block, type);
        });
      };
    }

    // Render inicial vacío (demo por defecto)
    (function boot(){
      // construir 2 bloques de texto + 1 imagen demo sin archivos (usará altura del texto)
      document.getElementById('buildForms').click();
    })();
  </script>
</body>
</html>
